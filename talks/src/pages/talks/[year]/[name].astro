---
import EventLinkCard from '@/components/EventLinkCard.astro';
import SlideEmbed from '@/components/SlideEmbed.astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { findPresentations, type Presentation } from '@/utils/presentations';

export function getStaticPaths() {
  const presentations = findPresentations();
  return presentations.map((presentation) => ({
    params: { year: presentation.year, name: presentation.name },
    props: { presentation },
  }));
}

interface Props {
  presentation: Presentation;
}

const { presentation } = Astro.props;
const talk = presentation.talk;

function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<BaseLayout
  title={`${presentation.title} - kosui.me`}
  ogTitle={presentation.title}
  ogDescription={talk?.description?.trim() || `${presentation.title} - Presentation by kosui`}
  ogImage={`https://talks.kosui.me/og/talks/${presentation.year}/${presentation.name}.png`}
  ogUrl={`https://talks.kosui.me/talks/${presentation.year}/${presentation.name}/`}
  ogType="article"
  oembedUrl={`https://talks.kosui.me/api/oembed/${presentation.year}/${presentation.name}.json`}
>
  <main class="max-w-4xl mx-auto px-6 py-8">
    <nav class="mb-6">
      <a
        href="/"
        class="inline-flex items-center gap-1 text-sm text-terracotta dark:text-terracotta-light hover:underline"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"
          />
        </svg>
        一覧に戻る
      </a>
    </nav>

    <header class="mb-6">
      <h1 class="text-2xl font-bold text-charcoal dark:text-gray-100 mb-2">
        {presentation.title}
      </h1>
      <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-charcoal-light dark:text-gray-400">
        {talk?.date && <span>{formatDate(talk.date)}</span>}
        {talk?.event && <span>{talk.event}</span>}
        {
          talk?.duration && (
            <span class="inline-flex items-center gap-1">
              <svg
                class="w-3.5 h-3.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              {talk.duration}
            </span>
          )
        }
      </div>
    </header>

    {
      talk?.description && (
        <p class="text-charcoal-light dark:text-gray-400 mb-6">
          {talk.description.trim()}
        </p>
      )
    }

    {
      talk?.tags && talk.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-6">
          {
            talk.tags.map((tag) => (
              <span
                class="inline-block px-3 py-1 text-sm rounded-full bg-sand dark:bg-gray-700 text-charcoal dark:text-gray-300"
              >
                {tag}
              </span>
            ))
          }
        </div>
      )
    }

    <section class="mb-6">
      <SlideEmbed presentation={presentation} />
    </section>

    {
      presentation.ogpData && (
        <section class="mb-6">
          <h3 class="text-sm font-medium text-charcoal dark:text-gray-100 mb-2">
            Event Page
          </h3>
          <EventLinkCard ogpData={presentation.ogpData} />
        </section>
      )
    }

    {
      !presentation.ogpData && talk?.eventUrl && (
        <section class="mb-6">
          <h3 class="text-sm font-medium text-charcoal dark:text-gray-100 mb-2">
            Event Page
          </h3>
          <a
            href={talk.eventUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1 text-sm text-terracotta dark:text-terracotta-light hover:underline"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              />
            </svg>
            {talk.eventUrl}
          </a>
        </section>
      )
    }

    <div class="flex justify-center">
      <a
        href={presentation.slideType === 'local'
        ? presentation.basePath
        : presentation.external.url}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-cream dark:bg-gray-800 rounded-clay shadow-clay dark:shadow-clay-dark hover:shadow-clay-hover dark:hover:shadow-clay-dark-hover text-charcoal dark:text-gray-100"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
          />
        </svg>
        スライドを直接開く
      </a>
    </div>

    <section class="mt-8 mb-6">
      <h3 class="text-sm font-medium text-charcoal dark:text-gray-100 mb-3 text-center">
        Share
      </h3>
      <div class="flex flex-wrap justify-center gap-3" data-share-buttons>
        <a
          data-share="hatena"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-full bg-sand dark:bg-gray-700 text-charcoal dark:text-gray-300 hover:opacity-80 transition-opacity"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.47 2H3.53A1.45 1.45 0 002 3.38v17.24A1.45 1.45 0 003.53 22h16.94A1.45 1.45 0 0022 20.62V3.38A1.45 1.45 0 0020.47 2zM8.61 17.29c0 .7-.74 1.06-2.17 1.06-1.6 0-2.39-.49-2.39-1.47 0-.53.27-.95.82-1.25.27-.15.65-.26 1.14-.33.49-.07.79-.16.91-.27V14.5c0-.34-.22-.51-.67-.51-.52 0-.87.16-1.07.47l-1.16-.72c.48-.75 1.26-1.12 2.34-1.12 1.56 0 2.34.54 2.34 1.63v3.04h-.09zm-.65-6.44c-.31.3-.7.46-1.16.46-.47 0-.86-.15-1.18-.46a1.52 1.52 0 01-.48-1.15c0-.45.16-.84.48-1.15.32-.31.71-.46 1.18-.46.46 0 .85.15 1.16.46.31.31.46.7.46 1.15 0 .45-.15.84-.46 1.15zm7.93 6.65c-.6.5-1.47.75-2.63.75-1.08 0-1.92-.24-2.52-.71-.6-.48-.9-1.12-.9-1.94h1.97c.05.63.47.94 1.27.94.42 0 .74-.1.96-.29.22-.19.34-.45.34-.77 0-.33-.13-.59-.39-.77-.26-.18-.7-.27-1.31-.27h-.63v-1.52h.54c.49 0 .87-.08 1.14-.25.27-.17.4-.42.4-.77 0-.6-.36-.9-1.07-.9-.65 0-1.05.3-1.2.9l-1.83-.52c.17-.59.51-1.06 1.03-1.41.52-.35 1.17-.52 1.95-.52.89 0 1.6.22 2.13.66.53.44.8 1.01.8 1.72 0 .79-.36 1.35-1.07 1.68.44.15.79.41 1.04.79.25.38.38.81.38 1.29 0 .74-.28 1.35-.84 1.85h-.01zm4.6-1.36a1.02 1.02 0 01-.71.29c-.28 0-.52-.1-.71-.29a.98.98 0 01-.29-.71c0-.28.1-.52.29-.71a.97.97 0 01.71-.29c.28 0 .52.1.71.29.2.19.29.43.29.71 0 .28-.1.52-.29.71z" />
          </svg>
          Hatena
        </a>
        <a
          data-share="x"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-full bg-sand dark:bg-gray-700 text-charcoal dark:text-gray-300 hover:opacity-80 transition-opacity"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
          </svg>
          X
        </a>
        <a
          data-share="linkedin"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-full bg-sand dark:bg-gray-700 text-charcoal dark:text-gray-300 hover:opacity-80 transition-opacity"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
          </svg>
          LinkedIn
        </a>
        <a
          data-share="bluesky"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-full bg-sand dark:bg-gray-700 text-charcoal dark:text-gray-300 hover:opacity-80 transition-opacity"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.785 2.627 3.584 3.493 6.173 3.16-.388.543-.247 1.596.744 2.508-2.404.26-5.098 1.408-2.36 4.928C7.307 23.942 11.3 23.17 12 20.2c.7 2.97 4.693 3.742 6.819.643 2.738-3.52.044-4.668-2.36-4.928.991-.912 1.132-1.965.744-2.508 2.59.333 5.388-.533 6.173-3.16.246-.828.624-5.79.624-6.479 0-.688-.139-1.86-.902-2.203-.659-.3-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8z" />
          </svg>
          Bluesky
        </a>
        <a
          data-share="mastodon"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-full bg-sand dark:bg-gray-700 text-charcoal dark:text-gray-300 hover:opacity-80 transition-opacity"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 00.023-.043v-1.809a.052.052 0 00-.02-.041.053.053 0 00-.046-.01 20.282 20.282 0 01-4.709.547c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 01-.319-1.433.053.053 0 01.066-.054 19.648 19.648 0 004.622.536c.164 0 .329 0 .494-.003.9-.024 1.848-.07 2.737-.203 .027-.004.054-.01.08-.016 2.394-.436 4.674-1.774 4.907-5.228.009-.147.023-.646.023-.801 0-.245.062-2.462-.01-3.76" />
            <path d="M19.903 7.715v5.677h-2.291V7.886c0-1.198-.504-1.805-1.512-1.805-1.115 0-1.673.721-1.673 2.147v3.015h-2.278V8.228c0-1.426-.558-2.147-1.673-2.147-1.008 0-1.512.607-1.512 1.805v5.506H6.673V7.715c0-1.198.304-2.151.916-2.858.63-.707 1.457-1.07 2.482-1.07 1.187 0 2.087.455 2.686 1.366l.578.97.579-.97c.599-.911 1.499-1.366 2.686-1.366 1.025 0 1.852.363 2.482 1.07.612.707.916 1.66.916 2.858" />
          </svg>
          Mastodon
        </a>
        <a
          data-share="misskey"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-full bg-sand dark:bg-gray-700 text-charcoal dark:text-gray-300 hover:opacity-80 transition-opacity"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M23.193 9.006c-.092-.09-.217-.127-.338-.1l-4.753.978a10.893 10.893 0 00-2.986-3.464l1.785-4.503a.352.352 0 00-.07-.367.352.352 0 00-.362-.104L12.153 2.88a10.967 10.967 0 00-4.56-.52L5.935.135A.353.353 0 005.568 0a.352.352 0 00-.319.2L3.81 3.443A10.908 10.908 0 000 12.108c0 2.726 1 5.349 2.82 7.39l.002.002a.08.08 0 00.012.016c2.063 2.305 4.894 3.648 7.98 3.783.11.005.22.008.33.008a10.94 10.94 0 007.466-2.928c3.269-3.042 4.455-7.74 2.93-11.916l1.622-3.24a.35.35 0 00.031-.207z" />
          </svg>
          Misskey
        </a>
      </div>
    </section>

    <script define:vars={{ pageTitle: presentation.title, pageUrl: `https://talks.kosui.me/talks/${presentation.year}/${presentation.name}/` }}>
      const encodedUrl = encodeURIComponent(pageUrl);
      const encodedTitle = encodeURIComponent(pageTitle);
      const text = encodeURIComponent(`${pageTitle} ${pageUrl}`);

      const shareUrls = {
        hatena: `https://b.hatena.ne.jp/entry/s/${pageUrl.replace('https://', '')}`,
        x: `https://x.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`,
        linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
        bluesky: `https://bsky.app/intent/compose?text=${text}`,
        mastodon: `https://donshare.net/share.html?text=${text}`,
        misskey: `https://misskeyshare.link/share.html?text=${text}`,
      };

      document.querySelectorAll('[data-share]').forEach((el) => {
        const platform = el.getAttribute('data-share');
        if (platform && shareUrls[platform]) {
          el.setAttribute('href', shareUrls[platform]);
        }
      });
    </script>
  </main>
</BaseLayout>
