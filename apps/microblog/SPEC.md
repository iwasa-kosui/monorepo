# Microblog 仕様書

## 1. プロダクト概要

Microblogは、ActivityPubプロトコルに対応した分散型マイクロブログサービスです。MastodonやMisskeyなどのFediverseネットワークと相互運用可能で、ユーザーは自分のサーバーから他のサーバーのユーザーをフォローしたり、投稿を共有したりできます。

### 1.1 ポジショニング

```
┌─────────────────────────────────────────────────────────────────┐
│                      Fediverse (分散SNS)                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │  Mastodon   │ │  Misskey    │ │  Pleroma    │              │
│  │  サーバー   │ │  サーバー   │ │  サーバー   │  ...         │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘              │
│         │               │               │                      │
│         └───────────────┼───────────────┘                      │
│                         │                                      │
│              ┌──────────┴──────────┐                          │
│              │   ActivityPub       │                          │
│              │   プロトコル        │                          │
│              └──────────┬──────────┘                          │
│                         │                                      │
│                ┌────────┴────────┐                            │
│                │   Microblog     │ ← 本プロダクト              │
│                │   (このサーバー)│                            │
│                └─────────────────┘                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 背景：関連する外部システムとアクター

### 2.1 外部システム

| 外部システム               | 説明                                                  | 連携方式                                 |
| -------------------------- | ----------------------------------------------------- | ---------------------------------------- |
| **Fediverseサーバー**      | Mastodon、Misskey、Pleroma等のActivityPub対応サーバー | ActivityPubプロトコル（HTTP Signatures） |
| **Webブラウザ**            | ユーザーがサービスを利用するクライアント              | HTTP/HTML/JavaScript                     |
| **Push通知サービス**       | Web Push通知を配信するブラウザベンダーのサービス      | Web Push（VAPID認証）                    |
| **PostgreSQLデータベース** | データ永続化                                          | Drizzle ORM                              |
| **ファイルストレージ**     | 画像ファイルの保存                                    | ローカルファイルシステム                 |

### 2.2 アクター（人間）

| アクター             | 説明                                   | 主な関心事                           |
| -------------------- | -------------------------------------- | ------------------------------------ |
| **ローカルユーザー** | このサーバーにアカウントを持つユーザー | 投稿作成、タイムライン閲覧、通知受信 |
| **リモートユーザー** | 他のFediverseサーバーのユーザー        | フォロー、いいね、リポストの送受信   |
| **サーバー管理者**   | このMicroblogインスタンスを運用する人  | サーバー設定、監視、メンテナンス     |
| **未登録訪問者**     | アカウントを持たない閲覧者             | 公開プロフィール・投稿の閲覧         |

### 2.3 システムコンテキスト図

```
                         ┌─────────────────┐
                         │  リモートユーザー │
                         │  (Fediverse)    │
                         └────────┬────────┘
                                  │ ActivityPub
                                  │ (Follow/Like/Announce/Create/Delete)
                                  ▼
┌─────────────┐          ┌─────────────────┐          ┌─────────────┐
│ ローカル    │  HTTP    │                 │  HTTP    │ 未登録      │
│ ユーザー    │◄────────►│   Microblog     │◄────────►│ 訪問者      │
│             │  Cookie  │                 │          │             │
└─────────────┘          └────────┬────────┘          └─────────────┘
                                  │
              ┌───────────────────┼───────────────────┐
              │                   │                   │
              ▼                   ▼                   ▼
     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
     │ PostgreSQL  │     │ Push通知    │     │ ファイル    │
     │ データベース│     │ サービス    │     │ ストレージ  │
     └─────────────┘     └─────────────┘     └─────────────┘
```

---

## 3. ユースケース一覧

### 3.1 認証・アカウント管理

| ID         | ユースケース | アクター         | 対応機能        |
| ---------- | ------------ | ---------------- | --------------- |
| UC-AUTH-01 | サインアップ | 未登録訪問者     | `SignUpUseCase` |
| UC-AUTH-02 | サインイン   | ローカルユーザー | `SignInUseCase` |
| UC-AUTH-03 | サインアウト | ローカルユーザー | セッション破棄  |

### 3.2 投稿管理

| ID         | ユースケース           | アクター         | 対応機能               |
| ---------- | ---------------------- | ---------------- | ---------------------- |
| UC-POST-01 | 投稿を作成する         | ローカルユーザー | `CreatePostUseCase`    |
| UC-POST-02 | 投稿を削除する         | ローカルユーザー | `DeletePostUseCase`    |
| UC-POST-03 | 投稿に画像を添付する   | ローカルユーザー | 画像アップロードAPI    |
| UC-POST-04 | 投稿を閲覧する         | 全アクター       | `GetPostUseCase`       |
| UC-POST-05 | リモート投稿を受信する | リモートユーザー | `AddRemotePostUseCase` |

### 3.3 ソーシャル機能

| ID        | ユースケース                 | アクター         | 対応機能                     |
| --------- | ---------------------------- | ---------------- | ---------------------------- |
| UC-SOC-01 | ユーザーをフォローする       | ローカルユーザー | `SendFollowRequestUseCase`   |
| UC-SOC-02 | フォローを解除する           | ローカルユーザー | `UnfollowUseCase`            |
| UC-SOC-03 | フォローリクエストを承認する | システム（自動） | `AcceptFollowRequestUseCase` |
| UC-SOC-04 | 投稿にいいねする             | ローカルユーザー | `SendLikeUseCase`            |
| UC-SOC-05 | いいねを取り消す             | ローカルユーザー | （未実装）                   |
| UC-SOC-06 | 投稿をリポストする           | ローカルユーザー | `SendRepostUseCase`          |
| UC-SOC-07 | リモートいいねを受信する     | リモートユーザー | `AddReceivedLikeUseCase`     |
| UC-SOC-08 | リモートリポストを受信する   | リモートユーザー | `AddReceivedRepostUseCase`   |

### 3.4 タイムライン・閲覧

| ID       | ユースケース               | アクター         | 対応機能                      |
| -------- | -------------------------- | ---------------- | ----------------------------- |
| UC-TL-01 | ホームタイムラインを見る   | ローカルユーザー | `GetTimelineUseCase`          |
| UC-TL-02 | サーバータイムラインを見る | 全アクター       | `GetServerTimelineUseCase`    |
| UC-TL-03 | ユーザープロフィールを見る | 全アクター       | `GetUserProfileUseCase`       |
| UC-TL-04 | リモートユーザーを見る     | ローカルユーザー | `GetRemoteUserProfileUseCase` |

### 3.5 通知

| ID          | ユースケース           | アクター         | 対応機能                  |
| ----------- | ---------------------- | ---------------- | ------------------------- |
| UC-NOTIF-01 | 通知一覧を見る         | ローカルユーザー | `GetNotificationsUseCase` |
| UC-NOTIF-02 | Web Push通知を受け取る | ローカルユーザー | `SubscribePushUseCase`    |
| UC-NOTIF-03 | Web Push通知を解除する | ローカルユーザー | `UnsubscribePushUseCase`  |

### 3.6 ユースケース図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Microblog システム                            │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 認証                                                             │   │
│  │  (サインアップ) (サインイン) (サインアウト)                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 投稿管理                                                         │   │
│  │  (投稿作成) (投稿削除) (画像添付) (投稿閲覧)                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ソーシャル機能                                                   │   │
│  │  (フォロー) (アンフォロー) (いいね) (リポスト)                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ タイムライン                                                     │   │
│  │  (ホームTL) (サーバーTL) (プロフィール)                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 通知                                                             │   │
│  │  (通知一覧) (Push購読) (Push解除)                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
         △           △              △               △
         │           │              │               │
    ローカル    リモート       未登録訪問者    システム
    ユーザー    ユーザー                       (自動処理)
```

---

## 4. 機能仕様

### 4.1 認証機能

#### 4.1.1 サインアップ

- **エンドポイント**: `POST /sign-up`
- **入力**: ユーザー名、パスワード
- **処理**:
  1. ユーザー名の一意性チェック
  2. User集約の作成
  3. LocalActor集約の作成（ActivityPub用）
  4. Key集約の作成（署名用RSA鍵ペア生成）
  5. パスワードハッシュ化（Argon2i）
  6. Session集約の作成
- **出力**: セッションCookie設定、ホームへリダイレクト

#### 4.1.2 サインイン

- **エンドポイント**: `POST /sign-in`
- **入力**: ユーザー名、パスワード
- **処理**:
  1. ユーザー存在確認
  2. パスワード検証（Argon2i）
  3. Session集約の作成（有効期限: 7日）
- **出力**: セッションCookie設定、ホームへリダイレクト

### 4.2 投稿機能

#### 4.2.1 投稿作成

- **エンドポイント**: `POST /posts`
- **入力**: 投稿内容（テキスト）、画像URL（オプション、複数可）
- **制約**:
  - 投稿内容: 1〜500文字
  - 画像: 最大4枚、各5MB以下、JPEG/PNG/GIF/WebP対応
- **処理**:
  1. セッション検証
  2. Post集約の作成（LocalPost）
  3. TimelineItem集約の作成
  4. Image集約の作成（画像がある場合）
  5. ActivityPub Create Activity の送信（フォロワーへ配信）
- **出力**: ホームへリダイレクト

#### 4.2.2 投稿削除

- **エンドポイント**: `DELETE /api/v1/posts/:postId`
- **処理**:
  1. セッション検証
  2. 投稿所有者検証
  3. 関連エンティティの削除（カスケード）:
     - TimelineItem削除
     - LikeNotification削除
     - Repost削除
  4. Post集約の削除
  5. ActivityPub Delete Activity の送信
- **出力**: 成功レスポンス

#### 4.2.3 画像アップロード

- **エンドポイント**: `POST /api/v1/upload`
- **入力**: 画像ファイル（multipart/form-data）
- **処理**:
  1. ファイル形式検証（JPEG/PNG/GIF/WebP）
  2. ファイルサイズ検証（5MB以下）
  3. WebP形式への変換（quality: 80）
  4. ファイル保存
- **出力**: `{ imageId, url }`

### 4.3 ソーシャル機能

#### 4.3.1 フォロー

- **エンドポイント**: `POST /follow`
- **入力**: 対象ユーザーのActorId
- **処理**:
  1. セッション検証
  2. ActivityPub Follow Activity の送信
  3. 相手サーバーからのAccept受信を待機
  4. Follow集約の作成（Accept受信時）
- **出力**: リダイレクト

#### 4.3.2 いいね

- **エンドポイント**: `POST /api/v1/like`
- **入力**: 対象投稿のURI
- **処理**:
  1. セッション検証
  2. Like集約の作成
  3. ActivityPub Like Activity の送信
- **出力**: 成功レスポンス

#### 4.3.3 リポスト

- **エンドポイント**: `POST /api/v1/repost`
- **入力**: 対象投稿のPostId
- **処理**:
  1. セッション検証
  2. Repost集約の作成
  3. TimelineItem集約の作成
  4. ActivityPub Announce Activity の送信
- **出力**: 成功レスポンス

### 4.4 タイムライン機能

#### 4.4.1 ホームタイムライン

- **エンドポイント**: `GET /api/v1/home`
- **入力**: createdAt（カーソル、オプション）
- **処理**:
  1. セッション検証
  2. フォロー中ユーザー + 自分のTimelineItemを取得
  3. 投稿詳細情報の付与（著者、いいね状態、リポスト状態）
- **出力**: 投稿一覧（ページネーション対応）

#### 4.4.2 サーバータイムライン

- **エンドポイント**: `GET /` または `GET /server-timeline`
- **処理**: サーバー上の全公開投稿を新着順で取得
- **出力**: 投稿一覧

### 4.5 通知機能

#### 4.5.1 通知一覧

- **エンドポイント**: `GET /notifications`
- **処理**:
  1. セッション検証
  2. 未読/既読の通知を取得
  3. 通知詳細情報の付与（いいねした人、フォローした人）
- **出力**: 通知一覧ページ

#### 4.5.2 未読通知数

- **エンドポイント**: `GET /api/v1/notifications/count`
- **出力**: `{ count: number }`

#### 4.5.3 Web Push購読

- **エンドポイント**: `POST /api/push-subscriptions`
- **入力**: endpoint, p256dh, auth
- **処理**: PushSubscription集約の作成
- **出力**: 成功レスポンス

### 4.6 ActivityPub連携

#### 4.6.1 受信Activity処理

| Activity          | 処理内容                                                                    |
| ----------------- | --------------------------------------------------------------------------- |
| **Follow**        | フォローリクエスト受信 → 自動Accept → FollowNotification作成 → Web Push送信 |
| **Create (Note)** | リモート投稿受信 → RemotePost作成 → TimelineItem作成                        |
| **Delete**        | リモート投稿削除 → Post削除 → TimelineItem削除                              |
| **Like**          | いいね受信 → Like作成 → LikeNotification作成 → Web Push送信                 |
| **Undo (Follow)** | フォロー解除 → Follow削除                                                   |
| **Undo (Like)**   | いいね取り消し → Like削除 → LikeNotification削除                            |
| **Announce**      | リポスト受信 → Repost作成 → TimelineItem作成                                |

#### 4.6.2 公開エンドポイント（ActivityPub）

| パス                           | 説明                                 |
| ------------------------------ | ------------------------------------ |
| `/users/{username}`            | Actor プロフィール（JSON-LD）        |
| `/users/{username}/posts/{id}` | Note オブジェクト（JSON-LD）         |
| `/users/{username}/followers`  | Followers Collection                 |
| `/users/{username}/outbox`     | Outbox Collection（公開投稿一覧）    |
| `/users/{username}/inbox`      | Inbox エンドポイント（Activity受信） |
| `/inbox`                       | 共有 Inbox（サーバー全体での受信）   |

---

## 5. データモデル

### 5.1 集約一覧

| 集約                 | 責務                 | 主要プロパティ                       |
| -------------------- | -------------------- | ------------------------------------ |
| **User**             | ローカルユーザー管理 | userId, username                     |
| **Actor**            | ActivityPubアクター  | actorId, uri, logoUri, inboxUrl      |
| **Post**             | 投稿管理             | postId, content, actorId, createdAt  |
| **Like**             | いいね管理           | likeId, actorId, objectUri           |
| **Repost**           | リポスト管理         | repostId, actorId, originalPostId    |
| **Follow**           | フォロー関係         | followerId, followingId              |
| **Notification**     | 通知管理             | notificationId, type, isRead         |
| **Session**          | セッション管理       | sessionId, userId, expires           |
| **Key**              | 署名鍵管理           | keyId, userId, publicKey, privateKey |
| **TimelineItem**     | タイムライン項目     | timelineItemId, postId, createdAt    |
| **Image**            | 投稿画像             | imageId, postId, url, altText        |
| **PushSubscription** | Push購読             | subscriptionId, userId, endpoint     |

### 5.2 集約間の参照関係

```
User ─────────────────────────────────────────┐
  │                                           │
  ├──→ LocalActor ──→ Actor                  │
  │                      │                    │
  ├──→ Key               ├──→ Post ──→ Image │
  │                      │      │             │
  ├──→ Session           │      └──→ TimelineItem
  │                      │                    │
  └──→ PushSubscription  ├──→ Like           │
                         │                    │
                         ├──→ Repost ─────────┤
                         │                    │
                         └──→ Follow          │
                                              │
Notification ←────────────────────────────────┘
  (recipientUserId → User)
  (likerActorId / followerActorId → Actor)
```

---

## 6. 非機能要件

### 6.1 セキュリティ

- **認証**: セッションベース認証（Cookie）
- **パスワード**: Argon2iハッシュ化
- **ActivityPub署名**: HTTP Signatures（RSA-SHA256）
- **XSS対策**: HTMLサニタイゼーション（sanitize-html）
- **CSRF対策**: セッショントークン検証

### 6.2 パフォーマンス

- **N+1問題対策**: バッチ処理（Store/Resolver設計）
- **画像最適化**: WebP変換、キャッシュ制御（1年）
- **ページネーション**: カーソルベース（createdAt）

### 6.3 可用性

- **エラーハンドリング**: Result型による型安全なエラー処理
- **ログ**: @logtape/logtapeによる構造化ログ

---

## 7. 技術スタック

| カテゴリ              | 技術               |
| --------------------- | ------------------ |
| **ランタイム**        | Node.js            |
| **言語**              | TypeScript 5.9     |
| **Webフレームワーク** | Hono               |
| **ActivityPub**       | @fedify/fedify     |
| **ORM**               | Drizzle ORM        |
| **データベース**      | PostgreSQL         |
| **バリデーション**    | Zod 4.2            |
| **UI**                | React (JSX)        |
| **ビルドツール**      | Vite               |
| **テスト**            | Vitest, Fast-Check |
| **画像処理**          | Sharp              |
| **Web Push**          | web-push           |

---

## 8. 今後の拡張候補

以下は現時点で未実装だが、将来的に検討可能な機能です：

| 機能                 | 説明                                   | 関連ユースケース |
| -------------------- | -------------------------------------- | ---------------- |
| いいね取り消し       | ローカルユーザーによるいいね取り消し   | UC-SOC-05        |
| リポスト取り消し     | ローカルユーザーによるリポスト取り消し | -                |
| 投稿編集             | 投稿内容の編集（Update Activity）      | -                |
| メンション           | @username による言及と通知             | -                |
| ハッシュタグ         | #タグによる投稿分類と検索              | -                |
| ダイレクトメッセージ | 非公開メッセージ機能                   | -                |
| ブロック/ミュート    | ユーザーのブロック・ミュート機能       | -                |
| 検索                 | 投稿・ユーザー検索                     | -                |
| 管理機能             | モデレーション、サーバー設定           | -                |
