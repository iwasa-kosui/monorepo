# Article（記事）機能 PRD

## 1. 概要

### 1.1 背景

microblogでは、ユーザーは短い投稿（Post）を作成し、他のユーザーとリプライでスレッド形式の会話を行うことができる。しかし、長い議論や連続したツイートを「まとまったコンテンツ」として公開・共有する手段がない。

Twitterのスレッド機能やMediumの記事のように、複数の投稿をまとめて1つの「記事（Article）」として公開できれば、以下のユースケースに対応できる：

- 技術的な解説や知見の共有
- 連続した考察やストーリーの公開
- スレッド形式の議論を永続的なコンテンツとしてアーカイブ

### 1.2 目的

- 自分が投稿したPostとそのスレッド（全リプライチェーン）を「記事」として公開できるようにする
- 記事は下書き→公開→非公開の状態管理ができる
- ActivityPubを通じて他のFediverseサーバーからも閲覧可能にする

### 1.3 ユーザーストーリー

> ユーザーとして、自分が作成したスレッド（複数の投稿の連なり）を1つの記事としてまとめて公開したい。そうすることで、断片的な投稿ではなく、まとまった読み物として共有できる。

---

## 2. スコープ

### 2.1 対象範囲

| 項目                  | 対応    |
| --------------------- | ------- |
| 記事の作成（下書き）  | MVP     |
| 記事の公開            | MVP     |
| 記事の非公開化        | MVP     |
| 記事の削除            | MVP     |
| 記事のActivityPub配信 | MVP     |
| 記事一覧表示          | Phase 2 |
| 記事詳細ページ        | Phase 2 |
| 記事のタイトル編集    | Phase 2 |
| 記事のOGP/メタデータ  | Phase 2 |

### 2.2 対象外

- 記事の直接編集（スレッド内容の編集は元のPostで行う）
- 記事のコメント機能（リプライはPostレベルで行う）
- 記事のカテゴリ/タグ機能
- 記事の検索機能

---

## 3. 機能要件

### 3.1 記事の作成

**前提条件：**

- ユーザーがログインしている
- 自分が投稿したPostが存在する

**フロー：**

1. ユーザーが自分の投稿の詳細画面を開く
2. 「記事として公開」ボタンをクリック
3. 記事のタイトルを入力
4. 下書きとして保存される

**制約：**

- 1つのスレッド（rootPost）につき1つの記事のみ作成可能
- rootPostは自分が投稿したPostである必要がある

### 3.2 記事の公開

**前提条件：**

- 下書き状態の記事が存在する

**フロー：**

1. ユーザーが下書き一覧から記事を選択
2. 「公開」ボタンをクリック
3. スレッド内容がArticle型としてActivityPub配信される
4. 記事のステータスが「公開中」に変更される

**配信先：**

- フォロワー全員のInbox
- 公開コレクション（Public）

### 3.3 記事の非公開化

**前提条件：**

- 公開中の記事が存在する

**フロー：**

1. ユーザーが公開中の記事を選択
2. 「非公開にする」ボタンをクリック
3. ActivityPub Delete Activityが配信される
4. 記事のステータスが「非公開」に変更される

**注意：**

- 非公開化後も記事データは削除されない（再公開可能）

### 3.4 記事の削除

**前提条件：**

- 記事が存在する（いずれのステータスでも可）

**フロー：**

1. ユーザーが記事を選択
2. 「削除」ボタンをクリック
3. 確認ダイアログを表示
4. 公開中の場合、ActivityPub Delete Activityが配信される
5. 記事データが削除される

### 3.5 スレッドの範囲

記事に含まれるスレッドの範囲：

- **rootPost**: 記事の起点となる投稿（自分が投稿したPost）
- **子孫（descendants）**: rootPostへのリプライ、およびそのリプライへのリプライ（再帰的）
- **他ユーザーの投稿**: スレッド内の他ユーザーの投稿も含む

**表示順序：**

- 時系列昇順（古い投稿から新しい投稿へ）

---

## 4. 非機能要件

### 4.1 パフォーマンス

- 記事公開処理は5秒以内に完了すること
- スレッド取得は100投稿まで対応すること

### 4.2 スケーラビリティ

- 1ユーザーあたり最大1000件の記事を保持可能
- 1記事あたり最大100投稿のスレッドを含む

### 4.3 ActivityPub互換性

- Article型オブジェクトはActivityPub仕様に準拠すること
- Mastodon、Pleroma、Misskeyなど主要なActivityPub実装で閲覧可能であること

---

## 5. ユーザーインターフェース

### 5.1 記事作成モーダル

```
┌─────────────────────────────────────┐
│ 記事として公開                        │
├─────────────────────────────────────┤
│ タイトル:                            │
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│ スレッド内容（プレビュー）:           │
│ ┌─────────────────────────────────┐ │
│ │ @kosui: 最初の投稿...           │ │
│ │ @alice: それに対するリプライ... │ │
│ │ @kosui: さらなる返信...         │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [キャンセル]    [下書き保存]         │
└─────────────────────────────────────┘
```

### 5.2 記事管理画面（Phase 2）

```
┌─────────────────────────────────────┐
│ マイ記事                            │
├─────────────────────────────────────┤
│ ● 公開中                            │
│   ├ 技術ブログの作り方 (2026-01-20) │
│   └ ActivityPub入門 (2026-01-15)   │
│                                     │
│ ○ 下書き                            │
│   └ 新しい記事タイトル (2026-01-23) │
│                                     │
│ ○ 非公開                            │
│   └ 古い記事 (2026-01-01)          │
└─────────────────────────────────────┘
```

---

## 6. ActivityPub配信形式

### 6.1 Article型オブジェクト

```json
{
  "@context": "https://www.w3.org/ns/activitystreams",
  "type": "Article",
  "id": "https://blog.kosui.me/users/kosui/articles/abc123",
  "attributedTo": "https://blog.kosui.me/users/kosui",
  "name": "ActivityPub入門",
  "content": "<article>...</article>",
  "published": "2026-01-23T12:00:00Z",
  "to": ["https://www.w3.org/ns/activitystreams#Public"],
  "cc": ["https://blog.kosui.me/users/kosui/followers"]
}
```

### 6.2 content形式

スレッド内の各投稿をHTMLでフォーマット：

```html
<article>
  <section class="post">
    <header>
      <strong>@kosui</strong>
      <time>2026-01-23T10:00:00Z</time>
    </header>
    <p>最初の投稿内容...</p>
  </section>
  <hr/>
  <section class="post">
    <header>
      <strong>@alice@example.com</strong>
      <time>2026-01-23T10:30:00Z</time>
    </header>
    <p>それに対するリプライ...</p>
  </section>
</article>
```

---

## 7. エッジケース

### 7.1 rootPostが削除された場合

- rootPost削除時に、関連するArticleも自動的に削除される
- 公開中の場合、Article用のDelete Activityも配信される

### 7.2 スレッド内の投稿が削除された場合

- 記事の内容は動的に取得されるため、削除された投稿は記事に含まれなくなる
- 既に配信済みのArticleは更新されない（受信側で古い内容が残る可能性あり）

### 7.3 スレッドに新しい投稿が追加された場合

- 記事の内容は動的に取得されるため、新しい投稿も自動的に含まれる
- 公開済み記事の更新を配信したい場合は、手動で再公開操作を行う（Phase 2以降）

---

## 8. 成功指標

| 指標                  | 目標値                      |
| --------------------- | --------------------------- |
| 記事作成数            | 月間10件以上（MVP期間）     |
| 記事公開率            | 下書きの50%以上が公開される |
| ActivityPub配信成功率 | 95%以上                     |

---

## 9. リリース計画

### MVP（Phase 1）

- 記事の作成/公開/非公開/削除
- ActivityPub配信
- 基本的なUIモーダル

### Phase 2

- 記事一覧画面
- 記事詳細ページ
- OGPメタデータ
- タイトル編集機能

### Phase 3（将来）

- 記事の再公開（Update Activity配信）
- スレッド投稿の選択的な除外
- 記事のカスタムスタイル

---

## 改訂履歴

| 日付       | バージョン | 変更内容 |
| ---------- | ---------- | -------- |
| 2026-01-23 | 1.0        | 初版作成 |
