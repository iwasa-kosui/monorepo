# ADR-001: Atlasによる宣言的スキーマ管理への移行

## ステータス
提案中（Proposed）

## コンテキスト

### 現在のスキーマ管理

現在、microblogアプリケーションは**Drizzle ORM + drizzle-kit**を使用してデータベーススキーマを管理している：

- **スキーマ定義**: `src/adaptor/pg/schema.ts`（TypeScript）
- **マイグレーションファイル**: `drizzle/`ディレクトリに15個のSQLファイル
- **コマンド**:
  - `drizzle:generate` - スキーマ変更からマイグレーション生成
  - `drizzle:migrate` - マイグレーション適用
  - `drizzle:push` - 開発時の直接プッシュ

### 現在のアプローチの課題

1. **命令型マイグレーション**: 開発者がマイグレーションの順序と内容を手動で管理する必要がある
2. **diff生成の限界**: drizzle-kitの自動生成は単純な変更に限定され、複雑なデータマイグレーション（例: `0014_migrate_objecturi_to_postid.sql`）は手動作成が必要
3. **環境間の一貫性**: 各環境でマイグレーション履歴の追跡が必要
4. **CI/CDの複雑さ**: マイグレーションの検証やlintingがビルトインでサポートされていない

### Atlasとは

[Atlas](https://atlasgo.io/)は、Ariga社が開発したデータベーススキーマ管理ツールで、以下の特徴を持つ：

- **宣言的アプローチ**: Terraformのように「あるべき状態」を定義し、現在の状態との差分を自動計算
- **版管理（Versioned）マイグレーション**: 従来の番号付きマイグレーションファイルもサポート
- **ハイブリッドワークフロー**: 開発時は宣言的、本番デプロイは版管理という使い分けが可能
- **ORM統合**: Drizzle ORMのスキーマをそのまま利用可能
- **スキーマlinting**: CI/CDでの自動検証

## 決定

**Atlasを導入し、宣言的スキーマ管理（ハイブリッドワークフロー）に移行する。**

### 選択したアプローチ: ハイブリッドワークフロー

```
[開発時]
Drizzle schema.ts → drizzle-kit export → Atlas → ローカルDB
      ↓
[コミット時]
atlas migrate diff → マイグレーションファイル生成 → コードレビュー
      ↓
[デプロイ時]
atlas migrate apply → 本番DB
```

1. **スキーマ定義はDrizzle ORMを継続使用**: 既存の`schema.ts`をそのまま活用
2. **開発時は宣言的**: `atlas schema apply`で素早くイテレーション
3. **本番向けは版管理**: `atlas migrate diff`でマイグレーションファイルを生成し、レビュー後に適用

## 代替案

### 代替案1: drizzle-kitの継続使用

**メリット**:
- 移行コストゼロ
- チームの既存知識を活用可能

**デメリット**:
- 宣言的ワークフローの恩恵を受けられない
- スキーマlintingがない
- 複雑なマイグレーションは引き続き手動

### 代替案2: Atlasの完全宣言的モード（Versioned Migrationsなし）

**メリット**:
- 最もシンプルなワークフロー

**デメリット**:
- 本番DBへの直接アクセスが必要
- マイグレーションのコードレビューが困難
- ロールバック戦略が限定的

### 代替案3: Atlasの完全版管理モード（純粋なVersioned Migrations）

**メリット**:
- 従来のマイグレーションワークフローと類似
- 変更履歴の完全な追跡

**デメリット**:
- 宣言的アプローチの利点（自動diff生成）を活かせない
- drizzle-kitと大差ない

## 帰結

### ポジティブ

1. **開発効率の向上**: 宣言的アプローチにより、スキーマ変更のイテレーションが高速化
2. **安全性の向上**: Atlasのスキーマlintingにより、危険な変更（データ損失など）を事前検出
3. **CI/CD統合**: GitHub Actionsでマイグレーションの自動検証が可能
4. **既存資産の活用**: Drizzle ORMのスキーマ定義をそのまま使用可能
5. **段階的移行**: 既存のdrizzleマイグレーションと共存可能

### ネガティブ

1. **新しいツールの学習コスト**: Atlasの設定とコマンドの習得が必要
2. **依存関係の増加**: Atlasバイナリの管理が必要
3. **複雑なデータマイグレーション**: 純粋なスキーマ変更以外（データ変換など）は引き続き手動介入が必要

### リスクと軽減策

| リスク | 軽減策 |
|--------|--------|
| 移行中のマイグレーション不整合 | ベースラインマイグレーションでスナップショットを取得 |
| Atlasの破壊的変更 | バージョン固定、定期的なアップデート確認 |
| チームの学習曲線 | ドキュメント整備、ペアプログラミング |

## 参考資料

- [Atlas公式ドキュメント](https://atlasgo.io/)
- [Atlas + Drizzle統合ガイド](https://atlasgo.io/guides/orms/drizzle/getting-started)
- [宣言的 vs 版管理マイグレーション](https://atlasgo.io/concepts/declarative-vs-versioned)
- [Atlas GitHub](https://github.com/ariga/atlas)
