name: Deploy Microblog

on:
  push:
    branches:
      - main
    paths:
      - "apps/microblog/**"
      - "packages/**"
      - ".github/workflows/deploy-microblog.yml"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build microblog
        run: |
          pnpm --filter @iwasa-kosui/result run build
          pnpm --filter microblog run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MICROBLOG_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.MICROBLOG_HOST }} >> ~/.ssh/known_hosts

      - name: Create env.conf
        working-directory: apps/microblog
        run: |
          cat > env.conf <<'EOF'
          [Service]
          Environment="DATABASE_URL=postgresql://microblog:${{ secrets.MICROBLOG_DB_PASSWORD }}@${{ secrets.MICROBLOG_DB_HOST }}/microblog"
          Environment="ORIGIN=https://blog.kosui.me"
          Environment="APP_ENV=production"
          Environment="DATABASE_CERT=/home/ec2-user/ap-northeast-1-bundle.pem"
          Environment="VAPID_PUBLIC_KEY=${{ secrets.VAPID_PUBLIC_KEY }}"
          Environment="VAPID_PRIVATE_KEY=${{ secrets.VAPID_PRIVATE_KEY }}"
          Environment="VAPID_SUBJECT=${{ secrets.VAPID_SUBJECT }}"
          Environment="UPLOAD_DIR=/home/ec2-user/uploads"
          EOF
          sed -i 's/^          //' env.conf

      - name: Deploy config files
        env:
          HOST: ${{ secrets.MICROBLOG_USER }}@${{ secrets.MICROBLOG_HOST }}
        working-directory: apps/microblog
        run: |
          ssh $HOST "sudo mkdir -p /etc/systemd/system/microblog.service.d"
          rsync -av --rsync-path="sudo rsync" microblog.service $HOST:/etc/systemd/system/microblog.service
          rsync -av --rsync-path="sudo rsync" microblog.sh $HOST:/usr/local/bin/microblog
          rsync -av --rsync-path="sudo rsync" nginx.conf $HOST:/etc/nginx/nginx.conf
          rsync -av --rsync-path="sudo rsync" env.conf $HOST:/etc/systemd/system/microblog.service.d/env.conf

      - name: Deploy dist
        env:
          HOST: ${{ secrets.MICROBLOG_USER }}@${{ secrets.MICROBLOG_HOST }}
        run: |
          rsync -avz --delete apps/microblog/dist/ $HOST:~/monorepo/apps/microblog/dist/

      - name: Install dependencies and run migration on server
        env:
          HOST: ${{ secrets.MICROBLOG_USER }}@${{ secrets.MICROBLOG_HOST }}
        run: |
          ssh $HOST "
            cd ~/monorepo
            git fetch --all
            git checkout origin/main -- pnpm-lock.yaml apps/microblog/package.json packages/result
            export PATH=\$HOME/.local/share/pnpm:\$PATH
            pnpm install --frozen-lockfile
            cd apps/microblog
            pnpm run drizzle:push
          "

      - name: Restart services
        env:
          HOST: ${{ secrets.MICROBLOG_USER }}@${{ secrets.MICROBLOG_HOST }}
        run: |
          ssh $HOST "
            sudo chmod +x /usr/local/bin/microblog
            sudo systemctl daemon-reload
            sudo systemctl enable microblog
            sudo systemctl restart microblog
            sudo systemctl restart nginx
          "

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519
